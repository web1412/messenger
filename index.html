<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบห้องแชท</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>

    <style>
      .container {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.chat-container {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.header {
    position: sticky;
    top: 0;
    background-color: #4a90e2;
    z-index: 1000;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    padding-bottom: 70px; /* ให้พื้นที่สำหรับ input-area */
}

.input-area {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: white;
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    z-index: 1000;
}

@media (min-width: 768px) {
    .container {
        max-width: 768px;
        margin: auto;
    }
    .input-area {
        max-width: 768px;
        left: 50%;
        transform: translateX(-50%);
    }
}

@media (min-width: 1024px) {
    .container {
        max-width: 1024px;
    }
    .input-area {
        max-width: 1024px;
    }
}
      .message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
    clear: both;
}
.owner-message {
    background-color: #e3effd;
    float: right;
    border-bottom-right-radius: 5px;
}
.participant-message {
    background-color: #f1f0f0;
    float: left;
    border-bottom-left-radius: 5px;
}
.message img {
    display: block;
    margin: 5px 0;
}
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    font-family: 'Kanit', sans-serif;
    background-color: #f0f2f5;
    color: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}
.container {
    width: 100%;
    max-width: 100%;
    height: 100vh;
    background-color: white;
    border-radius: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.header {
    background-color: #4a90e2;
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 1.2em;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.room-code {
    display: flex;
    align-items: center;
    font-size: 0.9em;
}
.copy-icon {
    margin-left: 10px;
    cursor: pointer;
    transition: opacity 0.3s;
}
.copy-icon:hover {
    opacity: 0.8;
}
.content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    padding: 15px;
}
.lobby {
    text-align: center;
    max-width: 400px;
    margin: auto;
}
.input-group {
    display: flex;
    margin-bottom: 15px;
}
input[type="text"] {
    flex-grow: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 25px;
    font-size: 1em;
    outline: none;
    transition: border-color 0.3s;
}
input[type="text"]:focus {
    border-color: #4a90e2;
}
.button {
    padding: 12px 20px;
    background-color: #4a90e2;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
    font-size: 1em;
    font-weight: 500;
}
.button:hover {
    background-color: #3a7bc8;
    transform: translateY(-2px);
}
.join-button {
    margin-left: 10px;
}
.create-button {
    width: 100%;
    margin-top: 10px;
}
.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    background-color: #f9f9f9;
}
.message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    word-wrap: break-word;
    clear: both;
}
.owner-message {
    background-color: #e3effd;
    float: right;
    border-bottom-right-radius: 5px;
}
.participant-message {
    background-color: #f1f0f0;
    float: left;
    border-bottom-left-radius: 5px;
}
.message img {
    max-width: 100%;
    max-height: 200px;
    object-fit: contain;
    border-radius: 10px;
    margin-top: 5px;
}
.image-message {
    max-width: 60%;
}
.input-area {
    display: flex;
    padding: 15px;
    background-color: white;
    border-top: 1px solid #eee;
}
.input-area input[type="text"] {
    flex-grow: 1;
    margin-right: 10px;
}
.button-group {
    display: flex;
    gap: 10px;
}
.image-upload {
    display: none;
}
.image-upload-label {
    cursor: pointer;
    padding: 12px;
    background-color: #4a90e2;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s, transform 0.2s;
}
.image-upload-label:hover {
    background-color: #3a7bc8;
    transform: translateY(-2px);
}
.send-button {
    padding: 12px 20px;
}
.notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 25px;
    border-radius: 5px;
    font-size: 1em;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 2000;
    text-align: center;
    max-width: 80%;
}

.notification.show {
    opacity: 1;
}

.notification.error {
    background-color: rgba(255, 0, 0, 0.8);
}

.notification.success {
    background-color: rgba(0, 128, 0, 0.8);
}

@media (min-width: 768px) {
    .container {
        max-width: 768px;
        height: 90vh;
        border-radius: 20px;
        margin: auto;
    }
}

@media (min-width: 1024px) {
    .container {
        max-width: 1024px;
    }
}
.input-area {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: white;
    padding: 15px;
    border-top: 1px solid #eee;
    display: flex;
    z-index: 1000;
}

.chat-messages {
    padding-bottom: 70px; /* ปรับตามความสูงของ input-area */
}

@media (min-width: 768px) {
    .input-area {
        max-width: 768px;
        left: 50%;
        transform: translateX(-50%);
    }
}

@media (min-width: 1024px) {
    .input-area {
        max-width: 1024px;
    }
}
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Content will be dynamically inserted here -->
    </div>
    <div id="notification" class="notification"></div>

    <script>
        const app = document.getElementById('app');
        const notification = document.getElementById('notification');
        let currentRoomCode = '';
        let isOwner = false;
        let lastMessageTimestamp = 0;
        let checkInterval;
        let currentUserId = null;

        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function generateUserId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function showLobby() {
            clearInterval(checkInterval);
            app.innerHTML = `
                <div class="header">ยินดีต้อนรับสู่ระบบห้องแชท</div>
                <div class="content lobby">
                    <div class="input-group">
                        <input type="text" id="roomCodeInput" placeholder="ใส่รหัสห้องแชท">
                        <button class="button join-button" onclick="joinRoom()">เข้าร่วม</button>
                    </div>
                    <button class="button create-button" onclick="createRoom()">สร้างห้องใหม่</button>
                </div>
            `;
        }

        function showChatRoom(roomCode) {
            currentRoomCode = roomCode;
            let headerContent = isOwner 
                ? `<div class="room-code">รหัสห้อง: ${roomCode}<i class="fas fa-copy copy-icon" onclick="copyRoomCode()"></i></div>`
                : 'ห้องแชท';
            app.innerHTML = `
                <div class="header">
                    ${headerContent}
                    ${isOwner ? `<button class="button" onclick="deleteRoom()">ปิดการแชท</button>` : `<button class="button" onclick="leaveRoom()">ออกจากห้อง</button>`}
                </div>
                <div class="content">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="พิมพ์ข้อความ...">
                        <div class="button-group">
                            <input type="file" id="imageUpload" class="image-upload" accept="image/*" onchange="sendImage(event)">
                            <label for="imageUpload" class="image-upload-label"><i class="fas fa-image"></i></label>
                            <button class="button send-button" onclick="sendMessage()">ส่ง</button>
                        </div>
                    </div>
                </div>
            `;
            loadMessages();
            startCheckingNewMessages();
        }

        function joinRoom() {
    const roomCode = document.getElementById('roomCodeInput').value.toUpperCase();
    if (!roomCode) {
        showNotification('กรุณาใส่รหัสห้อง', 'error');
        return;
    }
    
    let roomData = JSON.parse(localStorage.getItem(roomCode));
    if (!roomData) {
        showNotification('ไม่พบห้องนี้', 'error');
        return;
    }

    if (roomData.participants.length >= 2) {
        showNotification('ห้องแชทเต็มแล้ว', 'error');
        return;
    }

    if (!currentUserId) {
        currentUserId = generateUserId();
    }

    if (!roomData.participants.includes(currentUserId)) {
        roomData.participants.push(currentUserId);
        localStorage.setItem(roomCode, JSON.stringify(roomData));
    }

    isOwner = roomData.owner === currentUserId;
    showChatRoom(roomCode);
}

        function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification show';
    if (type === 'error') {
        notification.classList.add('error');
    } else if (type === 'success') {
        notification.classList.add('success');
    }
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

        function createRoom() {
            const newRoomCode = generateRoomCode();
            if (!currentUserId) {
                currentUserId = generateUserId();
            }
            const roomData = {
                owner: currentUserId,
                participants: [currentUserId],
                messages: []
            };
            localStorage.setItem(newRoomCode, JSON.stringify(roomData));
            isOwner = true;
            showChatRoom(newRoomCode);
        }

        function deleteRoom() {
    localStorage.removeItem(currentRoomCode);
    showNotification('ปิดห้องแชทแล้ว', 'success');
    setTimeout(() => {
        showLobby();
    }, 1500);
}

        function leaveRoom() {
            let roomData = JSON.parse(localStorage.getItem(currentRoomCode));
            roomData.participants = roomData.participants.filter(id => id !== currentUserId);
            localStorage.setItem(currentRoomCode, JSON.stringify(roomData));
            showLobby();
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (message) {
                addMessageToChatWindow(message, isOwner ? 'owner' : 'participant', 'text');
                messageInput.value = '';
                saveMessage(message, isOwner ? 'owner' : 'participant', 'text');
            }
        }

        function sendImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    addMessageToChatWindow(imageData, isOwner ? 'owner' : 'participant', 'image');
                    saveMessage(imageData, isOwner ? 'owner' : 'participant', 'image');
                }
                reader.readAsDataURL(file);
            }
        }

        function addMessageToChatWindow(content, sender, type) {
            const chatMessages = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            
            if ((isOwner && sender === 'owner') || (!isOwner && sender === 'participant')) {
                messageElement.classList.add('owner-message');
            } else {
                messageElement.classList.add('participant-message');
            }
            
            if (type === 'text') {
                messageElement.textContent = content;
            } else if (type === 'image') {
                const img = document.createElement('img');
                img.src = content;
                img.style.maxWidth = '100%';
                img.style.borderRadius = '10px';
                messageElement.appendChild(img);
            }
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function saveMessage(content, sender, type) {
            let roomData = JSON.parse(localStorage.getItem(currentRoomCode));
            const timestamp = Date.now();
            roomData.messages.push({ content, sender, type, timestamp });
            localStorage.setItem(currentRoomCode, JSON.stringify(roomData));
            lastMessageTimestamp = timestamp;
        }

        function loadMessages() {
            let roomData = JSON.parse(localStorage.getItem(currentRoomCode));
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            roomData.messages.forEach(msg => {
                addMessageToChatWindow(msg.content, msg.sender, msg.type);
                if (msg.timestamp > lastMessageTimestamp) {
                    lastMessageTimestamp = msg.timestamp;
                }
            });
        }

        function startCheckingNewMessages() {
            clearInterval(checkInterval);
            checkInterval = setInterval(() => {
                let roomData = JSON.parse(localStorage.getItem(currentRoomCode));
                let newMessages = roomData.messages.filter(msg => msg.timestamp > lastMessageTimestamp);
                if (newMessages.length > 0) {
                    newMessages.forEach(msg => {
                        addMessageToChatWindow(msg.content, msg.sender, msg.type);
                    });
                    lastMessageTimestamp = newMessages[newMessages.length - 1].timestamp;
                }
            }, 1000);
        }

        function copyRoomCode() {
            navigator.clipboard.writeText(currentRoomCode).then(() => {
                showNotification('คัดลอกแล้ว', 'success');
            }).catch(err => {
                console.error('ไม่สามารถคัดลอกข้อความ: ', err);
                showNotification('ไม่สามารถคัดลอกข้อความ', 'error');
            });
        }

        if (!currentUserId) {
            currentUserId = generateUserId();
        }
        showLobby();
        function addMessageToChatWindow(content, sender, type) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    
    if ((isOwner && sender === 'owner') || (!isOwner && sender === 'participant')) {
        messageElement.classList.add('owner-message');
    } else {
        messageElement.classList.add('participant-message');
    }
    
    if (type === 'text') {
        messageElement.textContent = content;
    } else if (type === 'image') {
        const img = document.createElement('img');
        img.src = content;
        img.style.maxWidth = '200px'; // ปรับขนาดสูงสุดของรูปภาพ
        img.style.maxHeight = '200px'; // ปรับความสูงสูงสุดของรูปภาพ
        img.style.objectFit = 'contain'; // รักษาสัดส่วนของรูปภาพ
        img.style.borderRadius = '10px';
        messageElement.appendChild(img);
    }
    
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
function showChatRoom(roomCode) {
    currentRoomCode = roomCode;
    let headerContent = isOwner 
        ? `<div class="room-code">รหัสห้อง: ${roomCode}<i class="fas fa-copy copy-icon" onclick="copyRoomCode()"></i></div>`
        : 'ห้องแชท';
    app.innerHTML = `
        <div class="chat-container">
            <div class="header">
                ${headerContent}
                ${isOwner ? `<button class="button" onclick="deleteRoom()">ปิดการแชท</button>` : `<button class="button" onclick="leaveRoom()">ออกจากห้อง</button>`}
            </div>
            <div class="chat-messages" id="chatMessages"></div>
        </div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="พิมพ์ข้อความ...">
            <div class="button-group">
                <input type="file" id="imageUpload" class="image-upload" accept="image/*" onchange="sendImage(event)">
                <label for="imageUpload" class="image-upload-label"><i class="fas fa-image"></i></label>
                <button class="button send-button" onclick="sendMessage()">ส่ง</button>
            </div>
        </div>
    `;
    loadMessages();
    startCheckingNewMessages();
}
    </script>
</body>
</html>